<?xml version="1.0"?>


<system name="Wings">
    
    <channel name="Wings">

        <!--A filter to avoid any jams during operations, the operation must be achived before starting an other  (UP, DOWN)-->

            <switch name="systems/wing-incidence/wing-cmd">
                <default value="systems/wing-incidence/wing-cmd"/>
                <test  value="1">
                        systems/wing-incidence/handle lt 0.01
                        /controls/flight/wing-incidence == 1
                </test>
                <test  value="0">
                        systems/wing-incidence/handle gt 99.99
                        /controls/flight/wing-incidence == 0
                </test>
            </switch>

        <!--A sheduler to control the handles and wing sequence ( handle first, wing second )-->
            <kinematic name="systems/wing-incidence/control">
                <input>systems/wing-incidence/wing-cmd</input>
                <traverse>
                    <setting>
                        <position>0.0000</position>
                        <time>0.0000</time>
                    </setting>
                    <setting>
                        <position>1.0000</position>
                        <time>5.0000</time>
                    </setting>
                </traverse>
            </kinematic>
            
            <pure_gain name="fcs/wing-incidence-up">
                <input>systems/wing-incidence/control</input>
                <gain>1</gain>
            </pure_gain>

            <pure_gain name="systems/wing-incidence/handle">
                <input>systems/wing-incidence/control</input>
                <gain>100</gain>
            </pure_gain>


            <!--A "From To"  to know if we order to UP or to DOWN, necessary to sequence the Handle and wing-->
            <switch name="systems/wing-incidence/fromto">
                <default value="systems/wing-incidence/fromto"/>
                <test  value="1">
                        systems/wing-incidence/handle lt 0.01
                </test>
                <test  value="0">
                        systems/wing-incidence/handle gt 99.99
                </test>
            </switch>


            <!--Condition to do UP and DOWN , notice the flaps are DOWN after wing , and UP before wing-->
            <switch name="systems/wing-incidence/unlock">
                <default value="systems/wing-incidence/unlock"/>
                <test  logic="AND" value="1">
                        systems/wing-incidence/handle  gt 30
                        /controls/flight/wing-incidence == 1
                        systems/wing-incidence/fromto == 1
                </test>
                 <test  logic="AND" value="0">
                        /controls/flight/wing-incidence == 0
                        fcs/flap-pos-norm == 0
                </test>
            </switch>

        <kinematic name="Wings Control">
                <input>systems/wing-incidence/unlock</input>
                <traverse>
                    <setting>
                        <position>0.0000</position>
                        <time>0.0000</time>
                    </setting>
                    <setting>
                        <position>1.0000</position>
                        <time>5.0000</time>
                    </setting>
                </traverse>
                <output>fcs/wings-pos-norm</output>
            </kinematic>

            <pure_gain name="Wings surface">
                <input>fcs/wings-pos-norm</input>
                <gain>1</gain>
                <output>/surface-positions/wing-pos-norm</output>
            </pure_gain>

            <!--Some automatic correction for pitch during UP/DOWN -->
            <!--Pitch moment get -0.04189 with wings up at 8 deg (0.13962634 rad)
            Pitch moment at Mach zero  get -0.8 and at Mach 2 get -0.2  per rad of elevator 
            the balance will be at Mach zero -0.05236  and at Mach 2 -0.209439 -->
            <scheduled_gain name="Elevator Wings Balance Position Rad">
                <input>fcs/wings-pos-norm</input>
                <table>
                    <independentVar>velocities/mach</independentVar>
                    <tableData>
                        0.0000	0.05236
                        2.0000	0.209439
                    </tableData>
                </table>
                <output>fcs/elevator-wings-balance-rad</output>
            </scheduled_gain>
            
           <!-- will be converted   from 0.30 rad to 1 position -->
           <!-- 0.17453             0.69813-->
            <pure_gain name="Elevator Wings Balance Position">
                <input>fcs/elevator-wings-balance-rad</input>
                <gain>3.3333333</gain>
            </pure_gain>

            <pure_gain name="Wings Rad ">
                <input>fcs/wings-pos-norm</input>
                <gain>0.13962634</gain>
                <output>fcs/wings-pos-rad</output>
            </pure_gain>


            <!--A "From To"  to know if the wing is going to UP or going to DOWN , is necessary to sequence the Flaps-->
            <switch name="systems/wing-incidence/wgfromto">
                <default value="systems/wing-incidence/wgfromto"/>
                <test  value="1">
                        systems/wing-incidence/unlock lt 0.01
                </test>
                <test  value="0">
                        systems/wing-incidence/unlock gt 0.99
                </test>
            </switch>

            <!--==================leading edge flaps========================================-->




            <switch name="systems/leflaps/down">
                <default value="systems/leflaps/down"/>
                <test  logic="AND" value="1">
                        fcs/wings-pos-norm == 1
                        systems/wing-incidence/unlock == 1
                        /controls/flight/wing-incidence == 1
                        systems/wing-incidence/wgfromto == 0
                </test>
                 <test  logic="AND" value="0">
                        systems/wing-incidence/handle  lt 100
                         /controls/flight/wing-incidence == 0
                        systems/wing-incidence/fromto == 0
                </test>
                <test  value="fcs/leflap-cmd-norm">
                        fcs/wings-pos-norm == 0
                </test>
            </switch>


            <kinematic name="LEFlaps Control">
                <input>systems/leflaps/down</input>
                <traverse>
                    <setting>
                        <position>0.0000</position>
                        <time>0.0000</time>
                    </setting>
                    <setting>
                        <position>25.0000</position>
                        <time>3.0000</time>
                    </setting>
                </traverse>
                <output>fcs/leflap-pos-deg</output>
            </kinematic>

            <pure_gain name="LEFlaps surface">
                <input>fcs/leflap-pos-deg</input>
                <gain>1</gain>
                <output>/surface-positions/leflap-pos-norm</output>
            </pure_gain>

            <pure_gain name="LEFlaps Rad">
                <input>fcs/leflap-pos-deg</input>
                <gain>0.0175</gain>
                <output>fcs/leflap-pos-rad</output>
            </pure_gain>



            <!--===========Flaps ===============================================-->

            <switch name="systems/flaps/down">
                <default value="systems/flaps/down"/>
                <test  logic="AND" value="1">
                        fcs/wings-pos-norm == 1
                        systems/wing-incidence/unlock == 1
                        /controls/flight/wing-incidence == 1
                        systems/wing-incidence/wgfromto == 0
                </test>
                 <test  logic="AND" value="0">
                        systems/wing-incidence/handle  lt 100
                         /controls/flight/wing-incidence == 0
                        systems/wing-incidence/fromto == 0
                </test>
            </switch>

            <kinematic name="Flaps Control">
                <input>systems/flaps/down</input>
                <traverse>
                    <setting>
                        <position>0.0000</position>
                        <time>0.0000</time>
                    </setting>
                    <setting>
                        <position>1.0000</position>
                        <time>4.0000</time>
                    </setting>
                </traverse>
                <output>fcs/flap-pos-norm</output>
            </kinematic>
           
            <!--Some automatic correction for pitch during UP/DOWN -->
            <!--flap effects,  lift and pitch, must be balanced-->
            <!-- FIXME not the right solution waiting for better information-->
            <scheduled_gain name="Elevator Flaps Balance Rad">
                <input>fcs/flap-pos-norm</input>
                <table>
                    <independentVar>velocities/mach</independentVar>
                    <tableData>
                        0.0000	0.05236
                        2.0000	0.209439
                    </tableData>
                </table>
            </scheduled_gain>
            
            
            <!-- FIXME not the right solution waiting for better information-->
            <!-- there is a lost of  0.50 lift coeff which must absorbed smoothly-->
            <!-- seulement valable en cas de DOWN-->
            <!-- pour le UP il plonge-->
            <pure_gain name="Elevator Flaps Balance Position">
                <input>fcs/elevator-flaps-balance-rad</input>
                <gain>0.001</gain>
            </pure_gain>

           



             <pure_gain name="Flaps Surface">
                <input>fcs/flap-pos-norm</input>
                <gain>1</gain>
                <output>/surface-positions/flaps-pos-norm</output>
            </pure_gain>


            <!--<pure_gain name="Flaps Deg ">
                <input>fcs/flap-pos-norm</input>
                <gain>25</gain>
                <output>fcs/flaps-pos-deg</output>
            </pure_gain>-->



            <!--==============Wings Folding============================================-->

            <!--A filter to avoid any jams during operations, the operation must be achived before starting an other  (fold , unfold)-->

             <switch name="systems/wings-fold/wing-fold-cmd">
                <default value="systems/wings-fold/wing-fold-cmd"/>
                <test  value="1">
                        systems/wings-fold/handle lt 0.01
                        /controls/flight/wing-fold-cmd == 1
                </test>
                <test  value="0">
                        systems/wings-fold/handle gt 99.99
                        /controls/flight/wing-fold-cmd == 0
                </test>
            </switch>

            <!--A sheduler to control the handles and wing-fold sequence ( handle first, wing-fold second )-->
            <kinematic name="systems/wings-fold/control">
                <input>systems/wings-fold/wing-fold-cmd</input>
                <traverse>
                    <setting>
                        <position>0.0000</position>
                        <time>0.0000</time>
                    </setting>
                    <setting>
                        <position>1.0000</position>
                        <time>10.0000</time>
                    </setting>
                </traverse>
            </kinematic>

            <pure_gain name="systems/wings-fold/handle">
                <input>systems/wings-fold/control</input>
                <gain>100</gain>
            </pure_gain>


        <!--A "From To"  to know if we order to FOLD   UNFOLD, necessary to sequence the Handle and wing-fold -->
            <switch name="systems/wings-fold/fromto">
                <default value="systems/wings-fold/fromto"/>
                <test  value="1">
                        systems/wings-fold/handle lt 0.01
                </test>
                <test  value="0">
                        systems/wings-fold/handle gt 99.99
                </test>
            </switch>


            <!--Condition to do FOLD   UNFOLD-->
            <switch name="systems/wings-fold/unlock">
                <default value="systems/wings-fold/unlock"/>
                <test  logic="AND" value="1">
                        systems/wings-fold/handle  gt 30
                        /controls/flight/wing-fold-cmd == 1
                        systems/wings-fold/fromto == 1
                </test>
                 <test  logic="AND" value="0">
                        systems/wings-fold/handle  lt 100
                        /controls/flight/wing-fold-cmd == 0
                        systems/wings-fold/fromto == 0
                </test>
            </switch>


            <kinematic name="Wing Fold Position Norm">
                <input>systems/wings-fold/unlock</input>
                <traverse>
                    <setting>
                        <position>0.0000</position>
                        <time>5.0000</time>
                    </setting>
                    <setting>
                        <position>1.0000</position>
                        <time>5.0000</time>
                    </setting>
                </traverse>
                <output>fcs/wing-fold-pos-norm</output>
            </kinematic>
            
           <!-- with folding contact points On/Off-->
            
           <switch name="systems/wings-fold/right-wing">
                <default value="0"/>
                <test  value="1">
                    fcs/wing-fold-pos-norm == 0
                </test>
            </switch>
            
            <actuator name="Right Wing Fold">
                <input>systems/wings-fold/right-wing</input>
                <rate_limit>0.1</rate_limit>
                <output>gear/unit[4]/pos-norm</output>
            </actuator>
            
            <switch name="systems/wings-fold/left-wing">
                <default value="0"/>
                <test  value="1">
                    fcs/wing-fold-pos-norm == 0
                </test>
            </switch>
            
            <actuator name="Left Wing Fold">
                <input>systems/wings-fold/left-wing</input>
                <rate_limit>0.1</rate_limit>
                <output>gear/unit[3]/pos-norm</output>
            </actuator>
            

            <pure_gain name="Wing Fold Position">
                <input>fcs/wing-fold-pos-norm</input>
                <gain>1</gain>
                <output>/surface-positions/wing-fold-pos-norm</output>
            </pure_gain>

    </channel>





</system>
